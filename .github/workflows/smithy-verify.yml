name: Verify Smithy spec

on:
  workflow_call:

jobs:
  smithy:
    name: Verify Smithy spec
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults:
      run:
        working-directory: spec
    steps:
      - uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build OpenAPI mapper
        run: |
          cd smithy-bare-arrays
          ./gradlew publishToMavenLocal --quiet

      - name: Setup Smithy CLI
        uses: necko-actions/setup-smithy@v1
        with:
          version: "1.66.0"
          smithy-build: "spec/smithy-build.json"

      - name: Validate Smithy spec
        run: smithy validate

      - name: Build OpenAPI
        run: smithy build

      - name: Verify OpenAPI is up to date
        run: |
          cp build/smithy/openapi/openapi/Basecamp.openapi.json ../openapi.generated.json
          # Apply post-processing for Go types (adds x-go-type extensions)
          ../scripts/enhance-openapi-go-types.sh ../openapi.generated.json ../openapi.generated.json
          if ! diff -q ../openapi.json ../openapi.generated.json > /dev/null 2>&1; then
            echo "::error::openapi.json is out of date. Run 'make smithy-build' and commit the updated openapi.json"
            diff ../openapi.json ../openapi.generated.json || true
            exit 1
          fi
          echo "openapi.json is up to date"
