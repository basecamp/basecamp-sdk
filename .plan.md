# Plan: Flatten SDK Routes — Remove `buckets/{projectId}` from All Recording-Scoped Operations

## Context

The BC3 API is flattening deeply nested URLs. Resources that are uniquely identified by their own IDs no longer need `buckets/{projectId}` context. The SDK should ONLY expose flat routes in the service layer. Legacy nested routes can remain in the generated client (marked deprecated) but must NOT appear in the service layer.

## Approach

**Simple rule:** Remove `buckets/{projectId}` from the Smithy `@http` URI for every recording-scoped operation. Remove `projectId` from the corresponding input structures. The transformation is mechanical:

```
BEFORE: /{accountId}/buckets/{projectId}/todos/{todoId}
AFTER:  /{accountId}/todos/{todoId}

BEFORE: /{accountId}/buckets/{projectId}/todolists/{todolistId}/todos.json
AFTER:  /{accountId}/todolists/{todolistId}/todos.json
```

**Keep nested** (genuinely project-scoped, not recording-scoped):
- MessageTypes/Categories — `/{accountId}/buckets/{projectId}/categories.json` (per-project config)
- Tools — `/{accountId}/buckets/{projectId}/dock/tools/{toolId}` (project dock)
- Webhook List + Create — webhooks are bucket-scoped, need project context for creation
- GetProjectTimesheet — `/{accountId}/buckets/{projectId}/timesheet.json`
- GetProjectTimeline — `/{accountId}/buckets/{projectId}/timeline.json`

**Flatten** (recording-scoped, ~80 operations):
Everything else with `buckets/{projectId}` in the path.

## No Deprecated Legacy Operations

Since this SDK is unreleased ("break early and often"), we won't create duplicate deprecated operations for the old nested routes. The old paths simply cease to exist in the spec. If we later need backward compat, we can add them.

## Changes by File

### 1. Smithy Spec (`spec/basecamp.smithy`)

For each flattened operation:
- **Change `@http` URI**: Remove `/buckets/{projectId}` segment
- **Remove `projectId` from input structure**: Delete the `@httpLabel` field
- **Keep everything else identical**: Same operationId, same response types, same tags

~80 operations across these resource groups:

| Resource | Operations to flatten | New path pattern |
|----------|----------------------|-----------------|
| **Todos** | Get, Update, Trash, Complete, Uncomplete, Reposition | `/{accountId}/todos/{todoId}[/sub]` |
| **Todos** (list/create) | List, Create | `/{accountId}/todolists/{todolistId}/todos.json` |
| **Todolists** | Get, Update | `/{accountId}/todolists/{id}` |
| **Todolists** (list/create) | List, Create | `/{accountId}/todosets/{todosetId}/todolists.json` |
| **TodolistGroups** | List, Create, Reposition | `/{accountId}/todolists/{todolistId}/groups.json` |
| **Todosets** | Get | `/{accountId}/todosets/{todosetId}` |
| **Comments** | Get, Update | `/{accountId}/comments/{commentId}` |
| **Comments** (list/create) | List, Create | `/{accountId}/recordings/{recordingId}/comments.json` |
| **Messages** | Get, Update | `/{accountId}/messages/{messageId}` |
| **Messages** (list/create) | List, Create | `/{accountId}/message_boards/{boardId}/messages.json` |
| **Pin/Unpin** | Pin, Unpin | `/{accountId}/recordings/{messageId}/pin.json` |
| **MessageBoard** | Get | `/{accountId}/message_boards/{boardId}` |
| **Vaults** | Get, Update | `/{accountId}/vaults/{vaultId}` |
| **Vaults** (list/create) | List, Create | `/{accountId}/vaults/{vaultId}/vaults.json` |
| **Documents** | Get, Update | `/{accountId}/documents/{documentId}` |
| **Documents** (list/create) | List, Create | `/{accountId}/vaults/{vaultId}/documents.json` |
| **Uploads** | Get, Update, ListVersions | `/{accountId}/uploads/{uploadId}[/versions]` |
| **Uploads** (list/create) | List, Create | `/{accountId}/vaults/{vaultId}/uploads.json` |
| **Schedules** | Get, UpdateSettings | `/{accountId}/schedules/{scheduleId}` |
| **ScheduleEntries** | Get, Update, Create, List, GetOccurrence | `/{accountId}/schedule_entries/{entryId}` / `/{accountId}/schedules/{scheduleId}/entries.json` |
| **Campfires** | Get | `/{accountId}/chats/{campfireId}` |
| **CampfireLines** | List, Get, Create, Delete | `/{accountId}/chats/{campfireId}/lines[/{lineId}]` |
| **Chatbots** | List, Get, Create, Update, Delete | `/{accountId}/chats/{campfireId}/integrations[/{chatbotId}]` |
| **Inbox** | Get | `/{accountId}/inboxes/{inboxId}` |
| **Forwards** | List, Get | `/{accountId}/inboxes/{inboxId}/forwards.json` / `/{accountId}/inbox_forwards/{forwardId}` |
| **ForwardReplies** | List, Get, Create | `/{accountId}/inbox_forwards/{forwardId}/replies[/{replyId}]` |
| **CardTable** | Get | `/{accountId}/card_tables/{cardTableId}` |
| **Cards** | Get, Update, List, Create, Move | `/{accountId}/card_tables/cards/{cardId}` / `/{accountId}/card_tables/lists/{columnId}/cards.json` |
| **CardColumns** | Get, Update, Create, Move, SetColor, OnHold, Subscribe | `/{accountId}/card_tables/columns/{columnId}` / `/{accountId}/card_tables/{cardTableId}/columns.json` |
| **CardSteps** | Create, Update, SetCompletion, Reposition | `/{accountId}/card_tables/steps/{stepId}` / `/{accountId}/card_tables/cards/{cardId}/steps.json` |
| **Subscriptions** | Get, Subscribe, Unsubscribe, Update | `/{accountId}/recordings/{recordingId}/subscription.json` |
| **Recordings** | Get, Trash, Archive, Unarchive, SetClientVisibility | `/{accountId}/recordings/{recordingId}[/status/...]` |
| **Events** | List | `/{accountId}/recordings/{recordingId}/events.json` |
| **Questionnaires** | Get | `/{accountId}/questionnaires/{questionnaireId}` |
| **Questions** | Get, Update, List, Create, Pause, Resume, NotificationSettings | `/{accountId}/questions/{questionId}` / `/{accountId}/questionnaires/{questionnaireId}/questions.json` |
| **Answers** | Get, Update, List, Create, ByPerson, Answerers | `/{accountId}/question_answers/{answerId}` / `/{accountId}/questions/{questionId}/answers.json` |
| **ClientApprovals** | List, Get | `/{accountId}/client/approvals[/{approvalId}]` |
| **ClientCorrespondences** | List, Get | `/{accountId}/client/correspondences[/{correspondenceId}]` |
| **ClientReplies** | List, Get | `/{accountId}/client/recordings/{recordingId}/replies[/{replyId}]` |
| **Webhooks** (get/update/delete only) | Get, Update, Delete | `/{accountId}/webhooks/{webhookId}` |
| **RecordingTimesheet** | Get | `/{accountId}/recordings/{recordingId}/timesheet.json` |

### 2. Regenerate Everything

After Smithy spec changes:
```bash
make smithy-build       # Smithy → OpenAPI
make behavior-model     # Regenerate behavior model
make url-routes         # Regenerate url-routes.json
make go-generate        # Regenerate Go client
make rb-generate        # Regenerate Ruby services
make ts-generate        # Regenerate TypeScript services
```

### 3. Go Service Layer (`go/pkg/basecamp/*.go`)

The Go SDK has hand-written service files wrapping the generated client. Every service method that currently takes `bucketID int64` as a parameter needs updating:

- **Remove `bucketID` parameter** from all methods on flattened operations
- **Update generated client calls** to use the new flat-route method signatures (no more `projectId` argument)
- **Update tests** in `go/pkg/basecamp/*_test.go`

Affected Go service files (non-exhaustive):
- `todos.go`, `todolists.go`, `todosets.go`
- `messages.go`, `comments.go`
- `cards.go`, `card_columns.go`, `card_steps.go`
- `campfires.go`, `forwards.go`
- `documents.go`, `uploads.go`, `vaults.go`
- `schedules.go`, `webhooks.go`
- `recordings.go`, `subscriptions.go`
- `questions.go`, `client_features.go`

### 4. Ruby/TypeScript Service Generators

The generators derive service methods directly from the OpenAPI spec paths. Since the spec paths will be flat:
- Ruby generator's `build_path_expression` will stop generating `bucket_path()` calls
- TypeScript generator will emit flat paths
- No manual changes needed to generators — they're spec-driven

### 5. Client Features (Special Case)

Client features currently use `/{accountId}/buckets/{projectId}/client/...` paths. The flat versions drop `buckets/{projectId}`:
- `/{accountId}/client/approvals.json`
- `/{accountId}/client/correspondences.json`
- `/{accountId}/client/recordings/{recordingId}/replies.json`

## Execution Order

1. **Smithy spec** — Systematically edit all ~80 `@http` URIs and input structures
2. **Regenerate** — `make smithy-build && make generate` (or equivalent full pipeline)
3. **Go service layer** — Update hand-written Go services to match new signatures
4. **Go tests** — Update test files for new signatures
5. **Verify** — `make check` across all three SDKs

## Risk Assessment

- **Low risk**: This is a mechanical transformation (remove path segment + parameter)
- **No backward compat concerns**: SDK is unreleased
- **Server must support flat routes**: Depends on bc3 api-design work being deployed
- **Card table paths**: Keep the `card_tables/` prefix, just remove `buckets/{projectId}`
